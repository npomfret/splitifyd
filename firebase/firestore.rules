rules_version = '2';

// FIRESTORE SECURITY RULES - PRODUCTION READY
// These rules enforce proper security for all environments (dev, staging, production)
// Schema validation is handled at the application level via FirestoreWriter
// Environment parity principle: Dev and prod have identical code AND rules
// Security principle: Deny by default, allow only specific authenticated operations

service cloud.firestore {
  match /databases/{database}/documents {

    function isGroupActive(groupId) {
      let groupDoc = get(/databases/$(database)/documents/groups/$(groupId));
      return groupDoc != null && groupDoc.data.deletedAt == null;
    }

    // Groups collection - production security rules
    match /groups/{groupId} {
      // Allow read only for authenticated users who are group members
      allow read: if request.auth != null &&
        resource.data.deletedAt == null &&
        exists(/databases/$(database)/documents/group-memberships/$(request.auth.uid + '_' + groupId));

      // Deny all direct writes - only server functions can write to groups
      allow write: if false;
      
      // ShareLinks subcollection - for invite tracking
      match /shareLinks/{shareLinkId} {
        // Allow read for authenticated users to resolve share links
        allow read: if request.auth != null && isGroupActive(groupId);
        // Deny all direct writes - only server functions can write share links
        allow write: if false;
      }
      
      // Comments subcollection - for group discussions
      match /comments/{commentId} {
        // Allow read only for group members
        allow read: if request.auth != null &&
          isGroupActive(groupId) &&
          exists(/databases/$(database)/documents/group-memberships/$(request.auth.uid + '_' + groupId));
        // Only server functions can write comments
        allow write: if false;

        // Reactions subcollection on group comments
        match /reactions/{reactionId} {
          // Allow read for group members
          allow read: if request.auth != null &&
            isGroupActive(groupId) &&
            exists(/databases/$(database)/documents/group-memberships/$(request.auth.uid + '_' + groupId));
          // Only server functions can write reactions
          allow write: if false;
        }
      }
    }

    // Expenses collection - production security rules
    match /expenses/{expenseId} {
      // Allow read for any authenticated user
      allow read: if request.auth != null;

      // Deny all direct writes - only server functions can write to expenses
      allow write: if false;

      // Reactions subcollection on expenses
      match /reactions/{reactionId} {
        // Allow read for any authenticated user (expense membership is validated server-side)
        allow read: if request.auth != null;
        // Only server functions can write reactions
        allow write: if false;
      }

      // Comments subcollection - for expense discussions
      match /comments/{commentId} {
        // Allow read for any authenticated user
        allow read: if request.auth != null;
        // Only server functions can write comments
        allow write: if false;

        // Reactions subcollection on expense comments
        match /reactions/{reactionId} {
          // Allow read for any authenticated user
          allow read: if request.auth != null;
          // Only server functions can write reactions
          allow write: if false;
        }
      }
    }
    
    // Settlements collection - production security rules
    match /settlements/{settlementId} {
      // Allow read only for authenticated users who are the payer or payee
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.payerId || request.auth.uid == resource.data.payeeId);

      // Deny all direct writes - only server functions can write to settlements
      allow write: if false;

      // Reactions subcollection on settlements
      match /reactions/{reactionId} {
        // Allow read for authenticated users (settlement membership is validated server-side)
        allow read: if request.auth != null;
        // Only server functions can write reactions
        allow write: if false;
      }
    }
    
    // Balances collection - top-level for batch querying
    match /balances/{groupId} {
      // Allow read only for group members
      allow read: if request.auth != null &&
        isGroupActive(groupId) &&
        exists(/databases/$(database)/documents/group-memberships/$(request.auth.uid + '_' + groupId));

      // Deny all writes - only server functions can update balances
      allow write: if false;
    }
    
    // Users collection - users can read/create/update their own documents
    match /users/{userId} {
      // Allow read if user is reading their own document
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow create if user is creating their own document (but not setting role field)
      allow create: if request.auth != null &&
        request.auth.uid == userId &&
        !("role" in request.resource.data);

      // Allow update if user is updating their own document (but not role field)
      allow update: if request.auth != null &&
        request.auth.uid == userId &&
        resource != null &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(["role"]);
    }
    
    // Policies collection - allow all authenticated users to read, deny writes
    match /policies/{policyId} {
      // Allow all authenticated users to read policies
      allow read: if request.auth != null;

      // Deny all direct writes - only server functions can write policies
      allow write: if false;
    }
    
    // Group memberships collection (top-level V2 implementation)
    match /group-memberships/{membershipId} {
      // Users can read memberships where they are the user
      // Document ID format: userId_groupId, so we can extract userId from document ID
      allow read: if request.auth != null && 
        membershipId.matches('^' + request.auth.uid + '_.*') &&
        isGroupActive(resource.data.groupId);
      
      // Only server functions can write memberships (via admin SDK)
      allow write: if false;
    }

    // Activity feed collection - per-user subcollections
    match /activity-feed/{userId} {
      // No direct document reads or writes at the user scope
      allow read, write: if false;

      match /items/{itemId} {
        // Users can read their own activity feed items
        allow read: if request.auth != null && request.auth.uid == userId;

        // Activity feed items are populated by backend services only
        allow write: if false;
      }
    }

    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
