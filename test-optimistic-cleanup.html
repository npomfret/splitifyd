<!DOCTYPE html>
<html>
<head>
    <title>Optimistic Expense Cleanup Test</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container { padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; color: #155724; }
        .test-fail { background-color: #f8d7da; color: #721c24; }
        .expense-list { margin: 20px 0; padding: 10px; background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Optimistic Expense Cleanup Test</h1>
        <p>This test verifies that optimistic expenses are properly cleaned up when sync updates arrive.</p>
        
        <button onclick="runTest()">Run Test</button>
        
        <div id="test-results"></div>
        <div id="expense-list" class="expense-list"></div>
    </div>
    
    <script src="js/utils.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Mock setup
        const mockProject = {
            id: 'test-project-123',
            name: 'Test Project',
            members: {
                'member-1': { name: 'Alice', active: true },
                'member-2': { name: 'Bob', active: true }
            },
            expenses: {},
            settlements: {}
        };
        
        // Initialize test environment
        window.App = {
            currentProject: null,
            currentUser: { id: 'user-123' }
        };
        
        // Mock UI update functions
        window.updateMembersUI = function() {
            console.log('updateMembersUI called');
        };
        
        window.updateExpensesUI = function() {
            console.log('updateExpensesUI called');
            displayExpenses();
        };
        
        window.updateBalancesUI = function() {
            console.log('updateBalancesUI called');
        };
        
        // Mock Utils.getProjectIdFromUrl
        const originalGetProjectId = Utils.getProjectIdFromUrl;
        Utils.getProjectIdFromUrl = function() {
            return 'test-project-123';
        };
        
        function displayExpenses() {
            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '<h3>Current Expenses:</h3>';
            
            if (!window.App.currentProject || !window.App.currentProject.expenses) {
                expenseList.innerHTML += '<p>No expenses</p>';
                return;
            }
            
            Object.entries(window.App.currentProject.expenses).forEach(([id, expense]) => {
                const div = document.createElement('div');
                div.style.padding = '5px';
                div.style.margin = '5px 0';
                div.style.background = expense._isOptimistic ? '#ffeaa7' : '#dfe6e9';
                div.innerHTML = `
                    <strong>${expense.description}</strong> - $${expense.amount}
                    ${expense._isOptimistic ? ' <span style="color: #e17055;">(Optimistic - Saving...)</span>' : ''}
                    <br><small>ID: ${id}</small>
                `;
                expenseList.appendChild(div);
            });
        }
        
        function addTestResult(description, success, details = '') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;
            div.innerHTML = `
                <strong>${success ? '‚úÖ' : '‚ùå'} ${description}</strong>
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            results.appendChild(div);
        }
        
        async function runTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h2>Test Results:</h2>';
            
            console.log('Starting optimistic expense cleanup test...');
            
            // Step 1: Set up initial project state
            window.App.currentProject = structuredClone(mockProject);
            displayExpenses();
            
            // Step 2: Add optimistic expenses (simulating user adding expenses)
            const optimisticExpense1 = {
                id: 'temp-expense-1',
                description: 'Optimistic Lunch',
                amount: 25.00,
                paidBy: 'member-1',
                splitBetween: ['member-1', 'member-2'],
                _isOptimistic: true,
                created: new Date().toISOString()
            };
            
            const optimisticExpense2 = {
                id: 'temp-expense-2',
                description: 'Optimistic Coffee',
                amount: 10.00,
                paidBy: 'member-2',
                splitBetween: ['member-1', 'member-2'],
                _isOptimistic: true,
                created: new Date().toISOString()
            };
            
            window.App.currentProject.expenses['temp-expense-1'] = optimisticExpense1;
            window.App.currentProject.expenses['temp-expense-2'] = optimisticExpense2;
            
            displayExpenses();
            addTestResult('Added 2 optimistic expenses', true, 'temp-expense-1, temp-expense-2');
            
            // Step 3: Simulate incoming sync with real expenses
            const syncedProjectData = {
                ...mockProject,
                expenses: {
                    'real-expense-1': {
                        id: 'real-expense-1',
                        description: 'Real Lunch',
                        amount: 25.00,
                        paidBy: 'member-1',
                        splitBetween: ['member-1', 'member-2'],
                        created: new Date().toISOString()
                    },
                    'real-expense-2': {
                        id: 'real-expense-2',
                        description: 'Real Coffee',
                        amount: 10.00,
                        paidBy: 'member-2',
                        splitBetween: ['member-1', 'member-2'],
                        created: new Date().toISOString()
                    },
                    'real-expense-3': {
                        id: 'real-expense-3',
                        description: 'Real Dinner',
                        amount: 50.00,
                        paidBy: 'member-1',
                        splitBetween: ['member-1', 'member-2'],
                        created: new Date().toISOString()
                    }
                }
            };
            
            // Store the current state before sync
            const expensesBeforeSync = Object.keys(window.App.currentProject.expenses);
            const optimisticCount = expensesBeforeSync.filter(id => 
                window.App.currentProject.expenses[id]._isOptimistic
            ).length;
            
            addTestResult('State before sync', true, 
                `Total expenses: ${expensesBeforeSync.length}, Optimistic: ${optimisticCount}`);
            
            // Step 4: Trigger the sync update logic
            // This simulates what happens in syncProject when remote changes are detected
            const localData = window.App.currentProject;
            const mergedData = syncedProjectData;
            
            // Execute the sync update logic
            Utils.log('Remote changes detected, updating UI', null, 'INFO');
            
            const currentExpenses = window.App.currentProject.expenses || {};
            const optimisticExpenseIds = Object.keys(currentExpenses)
                .filter(id => currentExpenses[id]._isOptimistic);
            
            if (optimisticExpenseIds.length > 0) {
                Utils.logDebug(`Removing ${optimisticExpenseIds.length} optimistic expenses before sync update`);
                optimisticExpenseIds.forEach(id => {
                    delete mergedData.expenses[id];
                });
            }
            
            window.App.currentProject = mergedData;
            
            // Update UI
            window.updateExpensesUI();
            
            // Step 5: Verify results
            const expensesAfterSync = Object.keys(window.App.currentProject.expenses);
            const hasOptimisticExpenses = expensesAfterSync.some(id => 
                window.App.currentProject.expenses[id]._isOptimistic
            );
            
            addTestResult('Optimistic expenses cleaned up', !hasOptimisticExpenses,
                hasOptimisticExpenses ? 'Failed - still has optimistic expenses' : 'All optimistic expenses removed');
            
            addTestResult('Correct number of expenses after sync', 
                expensesAfterSync.length === 3,
                `Expected 3 real expenses, got ${expensesAfterSync.length}`);
            
            // Verify no duplicate expenses
            const expenseDescriptions = expensesAfterSync.map(id => 
                window.App.currentProject.expenses[id].description
            );
            const uniqueDescriptions = new Set(expenseDescriptions);
            
            addTestResult('No duplicate expenses', 
                expenseDescriptions.length === uniqueDescriptions.size,
                `${expenseDescriptions.length} expenses, ${uniqueDescriptions.size} unique`);
            
            // Final summary
            const allTestsPassed = !hasOptimisticExpenses && 
                                   expensesAfterSync.length === 3 && 
                                   expenseDescriptions.length === uniqueDescriptions.size;
            
            if (allTestsPassed) {
                addTestResult('All tests passed! üéâ', true, 
                    'Optimistic expenses are properly cleaned up on sync');
            } else {
                addTestResult('Some tests failed', false, 
                    'Check the results above for details');
            }
            
            console.log('Test completed. Final expenses:', window.App.currentProject.expenses);
        }
    </script>
</body>
</html>