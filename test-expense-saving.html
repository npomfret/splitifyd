<!DOCTYPE html>
<html>
<head>
    <title>Expense Saving Tests</title>
</head>
<body>
    <h1>Expense Saving Failure Tests</h1>
    <p>Check the console to see test output</p>
    <button onclick="runTests()">Run Tests</button>
    
    <script src="js/utils.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Mock localStorage for testing
        const originalLocalStorage = window.localStorage;
        
        function createMockLocalStorage(shouldFail = false, quotaExceeded = false) {
            const storage = {};
            return {
                getItem: (key) => {
                    if (shouldFail) throw new Error('LocalStorage read error');
                    return storage[key] || null;
                },
                setItem: (key, value) => {
                    if (quotaExceeded) throw new DOMException('QuotaExceededError');
                    if (shouldFail) throw new Error('LocalStorage write error');
                    storage[key] = value;
                },
                removeItem: (key) => {
                    if (shouldFail) throw new Error('LocalStorage remove error');
                    delete storage[key];
                },
                clear: () => {
                    if (shouldFail) throw new Error('LocalStorage clear error');
                    Object.keys(storage).forEach(key => delete storage[key]);
                }
            };
        }
        
        function getMockExpense(overrides = {}) {
            return {
                description: 'Test Expense',
                amount: 50.00,
                currency: 'USD',
                paidBy: 'member-123',
                splitBetween: ['member-123', 'member-456'],
                category: 'Food',
                ...overrides
            };
        }
        
        function getMockProject(overrides = {}) {
            return {
                id: '507f1f77bcf86cd799439011',
                name: 'Test Project',
                created: new Date().toISOString(),
                members: {
                    'member-123': {
                        id: 'member-123',
                        name: 'Test User',
                        joined: new Date().toISOString(),
                        addedBy: 'user-123',
                        active: true
                    }
                },
                expenses: {},
                settlements: {},
                edits: [],
                ...overrides
            };
        }
        
        function setupTestEnvironment() {
            // Reset to clean localStorage
            window.localStorage = createMockLocalStorage();
            
            // Initialize app with test data
            App.currentUser = {
                id: 'user-123',
                name: 'Test User',
                projects: ['507f1f77bcf86cd799439011'],
                lastCurrency: 'USD'
            };
            
            App.currentProject = getMockProject();
            
            // Initialize cache
            Cache.init();
            Cache.saveProject(App.currentProject.id, App.currentProject);
        }
        
        function runTests() {
            console.log('=== Running Expense Saving Failure Tests ===\n');
            
            let testsPassed = 0;
            let testsTotal = 0;
            
            function test(name, testFn) {
                testsTotal++;
                console.log(`Testing: ${name}`);
                try {
                    testFn();
                    console.log('✅ PASS\n');
                    testsPassed++;
                } catch (error) {
                    console.log('❌ FAIL:', error.message, '\n');
                }
            }
            
            // Test 1: Normal expense saving works
            test('Normal expense saving should work', () => {
                setupTestEnvironment();
                
                const expense = getMockExpense();
                const expenseId = App.addExpense(expense);
                
                if (!expenseId) throw new Error('addExpense returned no ID');
                if (!App.currentProject.expenses[expenseId]) throw new Error('Expense not added to project');
                
                // Check it was saved to cache
                const cachedProject = Cache.getProject(App.currentProject.id);
                if (!cachedProject.data.expenses[expenseId]) throw new Error('Expense not saved to cache');
                if (!cachedProject.dirty) throw new Error('Project not marked as dirty');
            });
            
            // Test 2: localStorage quota exceeded
            test('Should handle localStorage quota exceeded error', () => {
                setupTestEnvironment();
                window.localStorage = createMockLocalStorage(false, true);
                
                const expense = getMockExpense();
                
                try {
                    const expenseId = App.addExpense(expense);
                    throw new Error('Should have thrown quota exceeded error');
                } catch (error) {
                    if (!error.message.includes('QuotaExceededError') && error.name !== 'QuotaExceededError') {
                        throw new Error('Wrong error type: ' + error.message);
                    }
                }
            });
            
            // Test 3: localStorage write failure
            test('Should handle localStorage write failure', () => {
                setupTestEnvironment();
                
                const expense = getMockExpense();
                
                // Mock localStorage to fail after initial setup
                setTimeout(() => {
                    window.localStorage = createMockLocalStorage(true, false);
                }, 10);
                
                try {
                    const expenseId = App.addExpense(expense);
                    // The current implementation doesn't handle this - this test should expose the issue
                    console.log('Note: Current implementation does not handle localStorage failures');
                } catch (error) {
                    // This is actually good - we want errors to be thrown, not silently ignored
                    console.log('Good: Error was thrown:', error.message);
                }
            });
            
            // Test 4: Race condition between saveProject and markProjectDirty
            test('Should handle race conditions in cache operations', () => {
                setupTestEnvironment();
                
                const expense = getMockExpense();
                
                // Override saveProjects to simulate slow operation
                const originalSaveProjects = Cache.saveProjects;
                let callCount = 0;
                Cache.saveProjects = function(projects) {
                    callCount++;
                    console.log(`saveProjects call #${callCount}`);
                    return originalSaveProjects.call(this, projects);
                };
                
                const expenseId = App.addExpense(expense);
                
                // Restore original
                Cache.saveProjects = originalSaveProjects;
                
                if (callCount !== 2) {
                    throw new Error(`Expected 2 saveProjects calls, got ${callCount}`);
                }
                
                // Check final state
                const cachedProject = Cache.getProject(App.currentProject.id);
                if (!cachedProject.dirty) throw new Error('Project should be marked as dirty');
            });
            
            // Test 5: Corrupted project data validation
            test('Should handle corrupted project data during save', () => {
                setupTestEnvironment();
                
                // Corrupt the current project
                App.currentProject.members = null;
                
                const expense = getMockExpense();
                
                try {
                    const expenseId = App.addExpense(expense);
                    // Current implementation might not validate before saving
                    console.log('Note: Current implementation may not validate before saving');
                } catch (error) {
                    console.log('Error caught:', error.message);
                }
            });
            
            // Test 6: Missing required expense fields
            test('Should handle missing required expense fields', () => {
                setupTestEnvironment();
                
                const incompleteExpense = {
                    description: 'Incomplete Expense'
                    // Missing amount, paidBy, etc.
                };
                
                try {
                    const expenseId = App.addExpense(incompleteExpense);
                    console.log('Note: Current implementation does not validate expense data');
                } catch (error) {
                    console.log('Error caught:', error.message);
                }
            });
            
            // Test 7: Concurrent expense additions
            test('Should handle concurrent expense additions', () => {
                setupTestEnvironment();
                
                const expense1 = getMockExpense({ description: 'Expense 1' });
                const expense2 = getMockExpense({ description: 'Expense 2' });
                
                // Simulate rapid additions
                const id1 = App.addExpense(expense1);
                const id2 = App.addExpense(expense2);
                
                if (id1 === id2) throw new Error('Expense IDs should be unique');
                
                const cachedProject = Cache.getProject(App.currentProject.id);
                const expenseCount = Object.keys(cachedProject.data.expenses).length;
                if (expenseCount !== 2) throw new Error(`Expected 2 expenses, found ${expenseCount}`);
            });
            
            console.log(`\n=== Test Results: ${testsPassed}/${testsTotal} passed ===`);
            
            if (testsPassed < testsTotal) {
                console.log('\n⚠️  Some tests failed - these reveal issues that need to be fixed');
            } else {
                console.log('\n✅ All tests passed!');
            }
            
            // Restore original localStorage
            window.localStorage = originalLocalStorage;
        }
    </script>
</body>
</html>