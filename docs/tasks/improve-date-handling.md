# Improve Date Handling in Firestore

**Analysis of Current Implementation:**

The current implementation of date handling in the Firebase project is generally good, but there are some inconsistencies and areas for improvement.

- **Storage:** Dates are correctly stored as Firestore `Timestamp` objects, which is the recommended best practice.
- **Creation:** Dates are created from ISO strings using `Timestamp.fromDate(new Date(dateString))`. While this works, it relies on the `Date` constructor's parsing, which can be inconsistent.
- **Validation:**
    - Settlement dates are validated as ISO strings using `Joi.date().iso()`.
    - Expense dates are validated as strings, with a basic check using `new Date()` and `isNaN()`.
- **API:** Dates are returned as ISO strings, which is a standard practice.

**Recommendations:**

1.  **Standardize Date Validation:** Use `Joi.date().iso()` for all date validation to ensure consistency and prevent invalid date formats from being accepted. This should be applied to the expense validation to match the settlement validation.

2.  **Add Auditing Fields to Settlements:** The `settlements` collection is missing several important auditing fields that are present in other collections. Adding these fields will improve data consistency and provide valuable auditing information. The following fields should be added:
    - `createdAt`
    - `updatedAt`
    - `deletedAt`
    - `createdBy`
    - `deletedBy`

3.  **Use Server-Side Timestamps:** Instead of `new Date()`, use `Timestamp.now()` to ensure that all timestamps are generated by the Firebase server. This avoids any potential issues with client-side clock skew.

**Implementation Plan:**

1.  Update the `createExpenseSchema` and `updateExpenseSchema` in `firebase/functions/src/expenses/validation.ts` to use `Joi.date().iso()` for date validation.
2.  Update the `settlements` type definition in `firebase/functions/src/types/webapp-shared-types.ts` to include the new auditing fields.
3.  Update the `createSettlement` function in `firebase/functions/src/settlements/handlers.ts` to add the new auditing fields.
4.  Update all instances of `new Date()` with `Timestamp.now()` for creating new timestamps.
