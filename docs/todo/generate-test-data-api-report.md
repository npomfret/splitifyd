# Report: Refactoring `generate-test-data.js` to Use the API

**Date:** 2025-07-08

**Author:** Gemini

## 1. Summary

The current implementation of `generate-test-data.js` directly interacts with the Firestore database and Firebase Auth to create test data. This approach bypasses the application's API, leading to data that is inconsistent with what would be generated by the application in a real-world scenario. This report outlines the issues with the current approach and provides a detailed plan for refactoring the script to use the API, ensuring the integrity and consistency of test data.

## 2. Problem Analysis

The core issue is that `generate-test-data.js` does not use the same data creation pathways as the application itself. This leads to several significant problems:

*   **Bypassed Business Logic:** The script does not trigger the Cloud Functions (`onExpenseCreateV5`, `onExpenseWrite`) that are essential for aggregating expense data and updating group and user balances. This results in incomplete and inaccurate data.
*   **Inconsistent Data Structures:** The script manually creates data structures for users, groups, and expenses. This can lead to inconsistencies with the data structures created by the API, especially as the application evolves. For example, the API initializes `expenseCount` and `lastExpenseTime` for new groups, which the script does not.
*   **Lack of Validation:** The script does not benefit from the validation logic in the API handlers. This could result in the creation of invalid data that would be rejected by the API.
*   **Maintenance Overhead:** Having two separate codebases for data creation (the script and the API) increases the maintenance overhead. Any changes to the data model or business logic must be implemented in both places, which is error-prone.

## 3. Implementation Plan

To address these issues, `generate-test-data.js` will be refactored to use the application's API for all data creation operations. This will involve the following steps:

### Step 1: API Client Setup

A small API client will be created within the script to handle HTTP requests to the API endpoints. This client will be responsible for:

*   **Authentication:** The script will need to authenticate with the API. This will be achieved by first creating a user and then using the custom token returned by the `/login` endpoint (in a non-production environment) to authenticate subsequent requests.
*   **Request Handling:** The client will provide functions for making `POST` requests to the `/register`, `/createDocument`, and `/expenses` endpoints.

### Step 2: Refactor User Creation

The `createTestUser` function will be updated to:

1.  Make a `POST` request to the `/register` endpoint to create a new user.
2.  Make a `POST` request to the `/login` endpoint to get a custom token for the new user.
3.  Store the user's data and token for use in subsequent API requests.

### Step 3: Refactor Group Creation

The `createTestGroup` function will be updated to:

1.  Use the authenticated API client to make a `POST` request to the `/createDocument` endpoint.
2.  The request body will contain the group's data, as defined by the API.

### Step 4: Refactor Expense Creation

The `createTestExpense` function will be updated to:

1.  Use the authenticated API client to make a `POST` request to the `/expenses` endpoint.
2.  The request body will contain the expense's data, as defined by the API.

### Step 5: Script Execution Flow

The main `generateTestData` function will be updated to orchestrate the new API-driven data creation process. It will:

1.  Create the test users and collect their authentication tokens.
2.  Create the test groups, with each group being created by an authenticated user.
3.  Create the test expenses, with each expense being created by an authenticated user who is a member of the group.

### Step 6: Environment Configuration

The script will need to be configured with the base URL of the API. This will likely be `http://localhost:5001/splitifyd/us-central1/api`.

## 4. Benefits of the New Approach

*   **Data Consistency:** All test data will be created through the same pathways as production data, ensuring that it is consistent and accurate.
*   **Reduced Maintenance:** Changes to the data model or business logic will only need to be made in the API, reducing the maintenance overhead.
*   **Improved Test Reliability:** Tests running against the generated data will be more reliable, as the data will accurately reflect the state of the application.
*   **End-to-End Testing:** The script will effectively become an end-to-end test for the data creation process.

By following this plan, we can ensure that `generate-test-data.js` is a robust and reliable tool for populating the database with realistic and consistent test data.
